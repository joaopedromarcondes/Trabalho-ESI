<!DOCTYPE html>
<html>
  <head>
    <title>TrabalhoEsi</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

     <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <%= javascript_include_tag 'application', 'data-turbo-track': 'reload', defer: true %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  </head>

  <body>

    <header>
      <div class="app-title">
        <h1><%= link_to "Trabalho ESI", root_path %></h1>
      </div>
      <div class="user-login">
        <% if user_signed_in? %>
          <span class="greeting">OlÃ¡<%= ", #{current_user.name}" if current_user.name.present? %>!<% if current_user.respond_to?(:owned_upgrades) && current_user.owned_upgrades.include?('perfil_plus') %> (Premium)<% end %></span>
          <% if current_user.current_avatar.present? %>
            <% img_path = "avatars/#{current_user.current_avatar}.png" %>
            <% if asset_exists?(img_path) %>
              <%= image_tag img_path, class: 'avatar-mini', alt: current_user.current_avatar, style: 'margin-left:8px;' %>
            <% end %>
          <% elsif current_user.avatar.attached? %>
            <%= image_tag url_for(current_user.avatar), class: 'avatar-mini', alt: 'Foto de perfil', style: 'margin-left:8px;' %>
          <% end %>
          <div class="profile-dropdown">
            <button class="profile-toggle" aria-haspopup="true" aria-expanded="false" aria-label="Abrir menu do perfil">
              <div class="profile-link-content">
                <% if current_user.avatar.attached? %>
                  <%= image_tag url_for(current_user.avatar), class: 'avatar-mini', alt: 'Foto de perfil' %>
                <% else %>
                  <i class="profile-icon">ðŸ‘¤</i>
                <% end %>
                <span class="profile-text">
                  <span class="profile-label">Meu Perfil</span>
                  <i class="edit-icon" aria-hidden="true">âœŽ</i>
                </span>
              </div>
            </button>
            <ul class="profile-menu" role="menu" aria-label="Menu do perfil">
              <li role="none"><%= link_to 'Minha Atividade', users_activity_path, role: 'menuitem', class: 'profile-menu-item' %></li>
              <li role="none"><%= link_to 'Loja', store_path, role: 'menuitem', class: 'profile-menu-item' %></li>
              <li role="none"><%= link_to 'Editar Perfil', edit_user_registration_path, role: 'menuitem', class: 'profile-menu-item' %></li>
            </ul>
          </div>
            <script>
              (function(){
                try {
                  if (window.__profileMenuFallbackApplied) return; window.__profileMenuFallbackApplied = true;
                  document.addEventListener('click', function(e){
                    var t = e.target.closest && e.target.closest('.profile-toggle');
                    if (t) {
                      e.preventDefault();
                      var dd = t.closest('.profile-dropdown');
                      if (!dd) return;
                      if (dd.classList.contains('open')) dd.classList.remove('open'); else dd.classList.add('open');
                      return;
                    }
                    var open = document.querySelector('.profile-dropdown.open');
                    if (open && !e.target.closest('.profile-dropdown')) open.classList.remove('open');
                  });
                  document.addEventListener('keydown', function(e){ if (e.key === 'Escape'){ var open = document.querySelector('.profile-dropdown.open'); if(open) open.classList.remove('open'); } });
                } catch (err) { console && console.warn && console.warn('profile fallback failed', err); }
              })();
            </script>
          <%= button_to destroy_user_session_path, 
              method: :delete,
              class: 'logout-button',
              form: { class: 'logout-form' },
              data: { turbo: true } do %>
            <i class="logout-icon">â†’</i> Sair
          <% end %>
        <% else %>
          <%= link_to "Entrar", new_user_session_path %> |
          <%= link_to "Registrar um novo usuÃ¡rio", new_user_registration_path %>
        <% end %>
      </div>
    </header>

    <p class="notice" style="color: green;"><%= notice %></p>
    <p class="alert" style="color: red;"><%= alert %></p>

    <div class="conteudo"><%= yield %></div>

  </body>
</html>